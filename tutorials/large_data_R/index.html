
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://hbs-rcs.github.io/hbsgrid-docs/tutorials/large_data_R/">
      
      
        <link rel="prev" href="../scaling-work/">
      
      
        <link rel="next" href="../PythonWebScrape/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.20">
    
    
      
        <title>Large Data in R: Tools and Techniques - HBS Grid Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.e53b48f4.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-3P5QKSCGVL"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-3P5QKSCGVL",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-3P5QKSCGVL",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>if("undefined"!=typeof __md_analytics){var consent=__md_get("__consent");consent&&consent.analytics&&__md_analytics()}</script>
  

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="hbs" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#large-data-in-r-tools-and-techniques" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="https://www.hbs.edu/research-computing-services/" title="HBS Grid Documentation" class="md-header__button md-logo" aria-label="HBS Grid Documentation" data-md-component="logo">
      
  <img src="../../imgs/rcs.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            HBS Grid Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Large Data in R: Tools and Techniques
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/hbs-rcs/hbsgrid-docs" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  Start Here

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../software/" class="md-tabs__link">
          
  
  
  Software & Environments

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../storage/" class="md-tabs__link">
          
  
  
  Data & Storage

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../help/" class="md-tabs__link">
          
  
  
  Help & Support Requests

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../" class="md-tabs__link">
          
  
  
  Tutorials

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://www.hbs.edu/research-computing-services/" title="HBS Grid Documentation" class="md-nav__button md-logo" aria-label="HBS Grid Documentation" data-md-component="logo">
      
  <img src="../../imgs/rcs.png" alt="logo">

    </a>
    HBS Grid Documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/hbs-rcs/hbsgrid-docs" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Start Here
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Software & Environments
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Software & Environments
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../software/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    📦 Available Software
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../menulaunch/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    🚀 Run Desktop Applications
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../commandline/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    🐚 Use the Command-line
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../environments/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    🔙 Use Software Versions
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Data & Storage
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Data & Storage
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../storage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    💾 Storage & Databases
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../syncfiles/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    🔄 Copy and Transfer Files
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../worksafe/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    👥 Collaborate and Share
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Help & Support Requests
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Help & Support Requests
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../help/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Support Channels
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../accountmanagement/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Account & Project Requests
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../trouble/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Troubleshooting
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Tutorials
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Tutorials
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Topic list
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../scaling-work/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Parallel processing
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Large data in R
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Large data in R
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#set-up-and-example-data" class="md-nav__link">
    <span class="md-ellipsis">
      Set Up and Example Data
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nature-and-scope-of-the-problem-what-is-large-data" class="md-nav__link">
    <span class="md-ellipsis">
      Nature and Scope of the Problem: What is Large Data?
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#problem-example" class="md-nav__link">
    <span class="md-ellipsis">
      Problem example
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#general-strategies-and-principles" class="md-nav__link">
    <span class="md-ellipsis">
      General strategies and principles
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#solution-example" class="md-nav__link">
    <span class="md-ellipsis">
      Solution example
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#your-turn" class="md-nav__link">
    <span class="md-ellipsis">
      Your turn!
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#additional-resources" class="md-nav__link">
    <span class="md-ellipsis">
      Additional resources
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../PythonWebScrape/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Web Scraping in Python
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../nlp_with_python/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    NLP in Python
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../DatabaseDelimiters/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Database Delimiters
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../uncompress/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Extracting Archived/Compressed Files
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  <nav class="md-tags" >
    
      
      
      
        <a href="../#tag:large-data" class="md-tag">Large data</a>
      
    
      
      
      
        <a href="../#tag:r" class="md-tag">R</a>
      
    
  </nav>


  
    <a href="https://github.com/hbs-rcs/hbsgrid-docs/edit/main/docs/tutorials/large_data_R.md" title="Edit this page" class="md-content__button md-icon" rel="edit">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg>
    </a>
  
  


<h1 id="large-data-in-r-tools-and-techniques">Large Data in R: Tools and Techniques</h1>
<h2 id="set-up-and-example-data">Set Up and Example Data</h2>
<p>The examples and exercises require R and several R packages, including
<code>tidyverse</code>, <code>data.table</code>, <code>arrow</code>, and <code>duckdb</code>. This software is all 
installed and ready to use on the HBS Grid. If running elsewhere make sure
these required software programs are installed before proceeding.</p>
<p>You can download and extract the data used in the examples and exercises from
<a href="https://www.dropbox.com/s/vbodicsu591o7lf/original_csv.zip?dl=1">https://www.dropbox.com/s/vbodicsu591o7lf/original_csv.zip?dl=1</a> (this
is a 1.3Gb zip file). These data record for-hire vehicle (aka “ride
sharing”) trips in NYC in 2020. Each row contains the record of a trip
and the variable descriptions can be found in
<a href="https://www1.nyc.gov/assets/tlc/downloads/pdf/data_dictionary_trip_records_hvfhs.pdf">https://www1.nyc.gov/assets/tlc/downloads/pdf/data_dictionary_trip_records_hvfhs.pdf</a></p>
<h2 id="nature-and-scope-of-the-problem-what-is-large-data">Nature and Scope of the Problem: What is Large Data?</h2>
<p>Most popular data analysis software is designed to operate on data
stored in random access memory (aka just “memory” or “RAM”). This makes
modifying and copying data very fast and convenient, until you start
working with data that is too large for your computer’s memory system.
At that point you have two options: get a bigger computer or modify your
workflow to process the data more carefully and efficiently. This
workshop focuses on option two, using the <code>arrow</code> and <code>duckdb</code> packages
in R to work with data without necessarily loading it all into memory at
once.</p>
<p>A common definition of “big data” is “data that is too big to process
using traditional software”. We can use the term “large data” as a
broader category of “data that is big enough that you have to pay
attention to processing it efficiently”.</p>
<p>In a typical (traditional) program, we start with data on disk, in some
format. We read it in to memory, do some stuff to it on the CPU, store
the results of that stuff back in memory, then write those results back
to disk so they can be available for the future, as depicted below.</p>
<p><img alt="Flow of Data in A Program" src="../imgs/ComputerDataFlow.png" /> The reason
most data analysis software is designed to process data this way is
because “doing some stuff” is much much faster in RAM than it is if you
have to read values from disk every time you need them. The downside is
that RAM is much more expensive than disk storage, and typically
available in smaller quantities. Memory can only hold so much data and
we must either stay under that limit or buy more memory.</p>
<h2 id="problem-example">Problem example</h2>
<p>Grounding our discussion in a concrete problem example will help make
things clear. <strong>I want to know how many Lyft rides were taken in New
York City during 2020</strong>. The data is publicly available as documented at
<a href="https://www1.nyc.gov/site/tlc/about/tlc-trip-record-data.page">https://www1.nyc.gov/site/tlc/about/tlc-trip-record-data.page</a> and I
have made a subset available on dropbox as described in the Setup
section above for convenience. Documentation can be found at
<a href="https://www1.nyc.gov/assets/tlc/downloads/pdf/data_dictionary_trip_records_hvfhs.pdf">https://www1.nyc.gov/assets/tlc/downloads/pdf/data_dictionary_trip_records_hvfhs.pdf</a></p>
<p>In order to demonstrate large data problems and solutions I’m going to
artificially limit my system to 4Gb of memory. This will allow us to
quickly see what happens when we reach the memory limit, and to look at
solutions to that problem without waiting for our program to read in
hundreds of Gb of data. (There is no need to follow along with this
step, the purpose is just to make sure we all know what happens when you
run out of memory.)</p>
<p>Start by looking at the file names and sizes:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="n">fhvhv_csv_files</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">list.files</span><span class="p">(</span><span class="s">&quot;original_csv&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">recursive</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">full.names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="nf">data.frame</span><span class="p">(</span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fhvhv_csv_files</span><span class="p">,</span><span class="w"> </span><span class="n">size_Mb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">file.size</span><span class="p">(</span><span class="n">fhvhv_csv_files</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">1024</span><span class="o">^</span><span class="m">2</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>##                                               file   size_Mb
## 1  original_csv/2020/01/fhvhv_tripdata_2020-01.csv 1243.4975
## 2  original_csv/2020/02/fhvhv_tripdata_2020-02.csv 1313.2442
## 3  original_csv/2020/03/fhvhv_tripdata_2020-03.csv  808.5597
## 4  original_csv/2020/04/fhvhv_tripdata_2020-04.csv  259.5806
## 5  original_csv/2020/05/fhvhv_tripdata_2020-05.csv  366.5430
## 6  original_csv/2020/06/fhvhv_tripdata_2020-06.csv  454.5977
## 7  original_csv/2020/07/fhvhv_tripdata_2020-07.csv  599.2560
## 8  original_csv/2020/08/fhvhv_tripdata_2020-08.csv  667.6880
## 9  original_csv/2020/09/fhvhv_tripdata_2020-09.csv  728.5463
## 10 original_csv/2020/10/fhvhv_tripdata_2020-10.csv  798.4743
## 11 original_csv/2020/11/fhvhv_tripdata_2020-11.csv  698.0638
## 12 original_csv/2020/12/fhvhv_tripdata_2020-12.csv  700.6804
</code></pre></div>
<p>We can already guess based on these file sizes that with only 4 Gb of
RAM available we’re going to have a problem.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="nf">library</span><span class="p">(</span><span class="n">tidyverse</span><span class="p">)</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="n">fhvhv_data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">map</span><span class="p">(</span><span class="n">fhvhv_csv_files</span><span class="p">,</span><span class="w"> </span><span class="n">read_csv</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="nf">bind_rows</span><span class="p">(</span><span class="n">show_col_types</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>## Error in eval(expr, envir, enclos): cannot allocate vector of size 7.6 Mb
</code></pre></div>
<p>Perhaps you’ve seen similar messages before. Basically it means that we
don’t have enough memory available to hold the data we want to work
with. I previously ran the code chunk above with more memory and found
that it required just over 16 Gb. How can we work with data when we only
have 1/4 of the memory requirement available?</p>
<p><img alt="The Evergiven" src="../imgs/bigboat.png" /> <em>An example of a large object
causing a bottleneck</em></p>
<h2 id="general-strategies-and-principles">General strategies and principles</h2>
<p>Part of the problem with our first attempt is that CSV files do not make
it easy to quickly read subsets or select columns. In this section we’ll
spend some time identifying strategies for working with large data and
identify some tools that make it easy to implement those strategies.</p>
<h3 id="use-a-fast-binary-data-storage-format-that-enables-reading-data-subsets">Use a fast binary data storage format that enables reading data subsets</h3>
<p>CSVs, TSVs, and similar <em>delimited files</em> are all <em>text-based formats</em>
that are typically used to store tabular data. Other more general
text-based data storage formats are in wide use as well, including XML
and JSON. These text-based formats have the advantage of being both
human and machine readable, but text is a relatively inefficient way to
store data, and loading it into memory requires a time-consuming parsing
process to separate out the fields and records.</p>
<p>As an alternative to text-based data storage formats, <em>binary formats</em>
have the advantage of being more space efficient on disk and faster to
read. They often employ advanced compression techniques, store metadata,
and allow fast selective access to data subsets. These substantial
advantages come at the cost of human readability; you cannot easily
inspect the contents of binary data files directly. If you are concerned
with reducing memory use or data processing time this is probably a
trade-off you are happy to make.</p>
<p>The <code>parquet</code> binary storage format is among the best currently
available. Support in R is provided by the <code>arrow</code> package. In a moment
we’ll see how we can use the <code>arrow</code> package to dramatically reduce the
time it takes to get data from disk to memory and back.</p>
<h3 id="partition-the-data-on-disk-to-facilitate-chunked-access-and-computation">Partition the data on disk to facilitate chunked access and computation</h3>
<p>Memory requirements can be reduced by partitioning the data and
computation into chunks, running each one sequentially, and combining
the results at the end. It is common practice to partition the data on
disk storage to make this computational strategy more natural and
efficient. For example, the taxi data is already partitioned by year and
month.</p>
<h3 id="only-read-in-the-data-you-need">Only read in the data you need</h3>
<p>If we think carefully about it we’ll see that our previous attempt to
process the taxi data by reading in all the data at once was wasteful.
Not all the rows are Lyft rides, and the only column I really need is
the one that tells me if the ride was operated by Lyft or not. I can
perform the computation I need by only reading in that one column, and
only the rows for which the <code>hvfhs_license_num</code> column is equal to
<code>HV0005</code> (Lyft).</p>
<h3 id="use-streaming-data-tools-and-algorithms">Use streaming data tools and algorithms</h3>
<p>It’s all fine and good to say “only read the data you need”, but how do
you actually do that? Unless you have full control over the data
collection and storage process, chances are good that your data provider
included a bunch of stuff you don’t need. The key is to find a data
selection and filtering tool that works in a streaming fashion so that
you can access subsets without ever loading data you don’t need into
memory. Both the <code>arrow</code> and <code>duckdb</code> R packages support this type of
workflow and can dramatically reduce the time and hardware requirements
for many computations.</p>
<p>Moreover, processing data in a streaming fashion without needing to load
it into memory is a general technique that can be applied to other tasks
as well. For example the <code>duckdb</code> package allows you to carry out data
aggregation in a streaming fashion, meaning that you can compute summary
statistics for data that is too large to fit in memory.</p>
<h3 id="avoid-unnecessarily-storing-or-duplicating-data-in-memory">Avoid unnecessarily storing or duplicating data in memory</h3>
<p>It is also important to pay some attention to storing and processing
data efficiently once we have it loaded in memory. R likes to make
copies of the data, and while it does try to avoid unnecessary
duplication this process can be unpredictable. At a minimum you can
remove or avoid storing intermediate results you don’t need and take
care not to make copies of your data structures unless you have to. The
<code>data.table</code> package additionally makes it easier to efficiently modify
R data objects in-place, reducing the risk of accidentally or
unknowingly duplicating large data structures.</p>
<h3 id="technique-summary">Technique summary</h3>
<p>We’ve accumulated a list of helpful techniques! To review:</p>
<ul>
<li>Use a fast binary data storage format that enables reading data
    subsets</li>
<li>Partition the data on disk to facilitate chunked access and
    computation</li>
<li>Only read in the data you need</li>
<li>Use streaming data tools and algorithms</li>
<li>Avoid unnecessarily storing or duplicating data in memory</li>
</ul>
<h2 id="solution-example">Solution example</h2>
<p>Now that we have some theoretical foundations to build on we can start
putting these techniques into practice. Using the techniques identified
above will allow us to overcome the memory limitation we ran up against
before, and finally answer the question “<strong>How many Lyft rides were
taken in New York City during 2020?</strong>”?</p>
<h3 id="convert-csv-to-parquet">Convert .csv to parquet</h3>
<p>The first step is to take the slow and inefficient text-based data
provided by the city of New York and convert it to parquet using the
<code>arrow</code> package. This is a one-time up-front cost that may be expensive
in terms of time and/or computational resources. If you plan to work
with the data a lot it will be well worth it because it allows
subsequent reads to be faster and more memory efficient.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="nf">library</span><span class="p">(</span><span class="n">arrow</span><span class="p">)</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="kr">if</span><span class="p">(</span><span class="o">!</span><span class="nf">dir.exists</span><span class="p">(</span><span class="s">&quot;converted_parquet&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="w">  </span><span class="nf">dir.create</span><span class="p">(</span><span class="s">&quot;converted_parquet&quot;</span><span class="p">)</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="w">  </span><span class="c1">## this doesn&#39;t yet read the data in, it only creates a connection</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="w">  </span><span class="n">csv_ds</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">open_dataset</span><span class="p">(</span><span class="s">&quot;original_csv&quot;</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="w">                         </span><span class="n">format</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;csv&quot;</span><span class="p">,</span>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="w">                         </span><span class="n">partitioning</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;year&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;month&quot;</span><span class="p">))</span>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a>
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="w">  </span><span class="c1">## this reads each csv file in the csv_ds dataset and converts it to a .parquet file</span>
<a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a><span class="w">  </span><span class="nf">write_dataset</span><span class="p">(</span><span class="n">csv_ds</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a><span class="w">                </span><span class="s">&quot;converted_parquet&quot;</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a><span class="w">                </span><span class="n">format</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;parquet&quot;</span><span class="p">,</span>
<a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a><span class="w">                </span><span class="n">partitioning</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;year&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;month&quot;</span><span class="p">))</span>
<a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a><span class="p">}</span>
</code></pre></div>
<p>This conversion is relatively easy (even with limited memory) because
the data provider is already using one of our strategies, i.e., they
partitioned the data by year/month. This allows us to convert each file
one at a time, without ever needing to read in all the data at once.</p>
<p>We also took care to preserve the <code>year/month</code> partition into
sub-directories. We improved on the implementation by using what is
known as “hive-style” partitioning, i.e., including both the variable
names and values in the directory names. This is convenient because it
makes it easy for <code>arrow</code> (and other tools that recognize the hive
partitioning standard) to automatically recognize the partitions.</p>
<p>We can look at the converted files and compare the naming scheme and
storage requirements to the original CSV data.</p>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="n">fhvhv_csv_files</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">list.files</span><span class="p">(</span><span class="s">&quot;original_csv&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">recursive</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">full.names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="n">fhvhv_files</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">list.files</span><span class="p">(</span><span class="s">&quot;converted_parquet&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">full.names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">recursive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="nf">data.frame</span><span class="p">(</span><span class="n">csv_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fhvhv_csv_files</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="w">           </span><span class="n">parquet_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fhvhv_files</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="w">           </span><span class="n">csv_size_Mb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">file.size</span><span class="p">(</span><span class="n">fhvhv_csv_files</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">1024</span><span class="o">^</span><span class="m">2</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="w">           </span><span class="n">parquet_size_Mb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">file.size</span><span class="p">(</span><span class="n">fhvhv_files</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">1024</span><span class="o">^</span><span class="m">2</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>                                                                 CSV        Parquet
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>                  csv_file                       parquet_file    size_Mb    size_Mb
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>fhvhv_tripdata_2020-01.csv   year=2020/month=1/part-0.parquet  1243.4975  190.26387
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>fhvhv_tripdata_2020-02.csv  year=2020/month=10/part-0.parquet  1313.2442  125.17837
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>fhvhv_tripdata_2020-03.csv  year=2020/month=11/part-0.parquet   808.5597  110.92144
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>fhvhv_tripdata_2020-04.csv  year=2020/month=12/part-0.parquet   259.5806  111.67697
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>fhvhv_tripdata_2020-05.csv   year=2020/month=2/part-0.parquet   366.5430  198.87074
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>fhvhv_tripdata_2020-06.csv   year=2020/month=3/part-0.parquet   454.5977  127.53637
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a>fhvhv_tripdata_2020-07.csv   year=2020/month=4/part-0.parquet   599.2560   48.32047
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a>fhvhv_tripdata_2020-08.csv   year=2020/month=5/part-0.parquet   667.6880   64.17768
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a>fhvhv_tripdata_2020-09.csv   year=2020/month=6/part-0.parquet   728.5463   76.45972
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a>fhvhv_tripdata_2020-10.csv   year=2020/month=7/part-0.parquet   798.4743   97.99151
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a>fhvhv_tripdata_2020-11.csv   year=2020/month=8/part-0.parquet   698.0638  107.80694
<a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a>fhvhv_tripdata_2020-12.csv   year=2020/month=9/part-0.parquet   700.6804  115.25221
</code></pre></div>
As expected, the binary parquet storage format is much more compact than
the text-based CSV format. This is one reason that reading parquet data
is so much faster:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="c1">## tidyverse csv reader</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="nf">system.time</span><span class="p">(</span><span class="nf">invisible</span><span class="p">(</span><span class="n">readr</span><span class="o">::</span><span class="nf">read_csv</span><span class="p">(</span><span class="n">fhvhv_csv_files</span><span class="p">[[</span><span class="m">1</span><span class="p">]],</span><span class="w"> </span><span class="n">show_col_types</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)))</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>##    user  system elapsed 
##  79.982   6.362  31.824
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="c1">## arrow package parquet reader</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="nf">system.time</span><span class="p">(</span><span class="nf">invisible</span><span class="p">(</span><span class="nf">read_parquet</span><span class="p">(</span><span class="n">fhvhv_files</span><span class="p">[[</span><span class="m">1</span><span class="p">]])))</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>##    user  system elapsed 
##   5.761   2.226  22.533
</code></pre></div>
<h3 id="read-and-count-lyft-records-with-arrow">Read and count Lyft records with arrow</h3>
<p>The <code>arrow</code> package makes it easy to read and process only the data we
need for a particular calculation. It allows us to use the partitioned
data directories we created earlier as a single dataset and to query it
using the <code>dplyr</code> verbs many R users are already familiar with.</p>
<p>Start by creating a dataset representation from the partitioned data
directory:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="n">fhvhv_ds</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">open_dataset</span><span class="p">(</span><span class="s">&quot;converted_parquet&quot;</span><span class="p">,</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="w">                         </span><span class="n">schema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">schema</span><span class="p">(</span><span class="n">hvfhs_license_num</span><span class="o">=</span><span class="nf">string</span><span class="p">(),</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="w">                                         </span><span class="n">dispatching_base_num</span><span class="o">=</span><span class="nf">string</span><span class="p">(),</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="w">                                         </span><span class="n">pickup_datetime</span><span class="o">=</span><span class="nf">string</span><span class="p">(),</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="w">                                         </span><span class="n">dropoff_datetime</span><span class="o">=</span><span class="nf">string</span><span class="p">(),</span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="w">                                         </span><span class="n">PULocationID</span><span class="o">=</span><span class="nf">int64</span><span class="p">(),</span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="w">                                         </span><span class="n">DOLocationID</span><span class="o">=</span><span class="nf">int64</span><span class="p">(),</span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="w">                                         </span><span class="n">SR_Flag</span><span class="o">=</span><span class="nf">int64</span><span class="p">(),</span>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="w">                                         </span><span class="n">year</span><span class="o">=</span><span class="nf">int32</span><span class="p">(),</span>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="w">                                         </span><span class="n">month</span><span class="o">=</span><span class="nf">int32</span><span class="p">()))</span>
</code></pre></div>
<p>Because we have hive-style directory names <code>open_dataset</code> automatically
recognizes the partitions. Note that usually we do not need to manually
specify the <code>schema</code>, we do so here to work around an issue with
<code>duckdb</code> support.</p>
<p>Importantly, <code>open_dataset</code> doesn’t actually read the data into memory.
It just opens a connection to the dataset and makes it easy for us to
query it. Finally, we can compute the number of NYC Lyft trips in 2020,
even on a machine with limited memory:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="nf">library</span><span class="p">(</span><span class="n">dplyr</span><span class="p">,</span><span class="w"> </span><span class="n">warn.conflicts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="n">fhvhv_ds</span><span class="w"> </span><span class="o">%&gt;%</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="w">  </span><span class="nf">filter</span><span class="p">(</span><span class="n">hvfhs_license_num</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;HV0005&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="w">  </span><span class="nf">select</span><span class="p">(</span><span class="n">hvfhs_license_num</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="w">  </span><span class="nf">collect</span><span class="p">()</span><span class="w"> </span><span class="o">%&gt;%</span>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="w">  </span><span class="nf">summarize</span><span class="p">(</span><span class="n">total_Lyft_trips</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">n</span><span class="p">())</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>## # A tibble: 1 × 1
##   total_Lyft_trips
##              &lt;int&gt;
## 1         37250101
</code></pre></div>
<p>Note that <code>arrow</code> datasets do not support <code>summarize</code> natively, that is
why we call <code>collect</code> first to actually read in the data.</p>
<p>The <code>arrow</code> package makes it fast and easy to query on-disk data and
read in only the fields and records needed for a particular computation.
This is a tremendous improvement over the typical R workflow, and may
well be all you need to start using your large datasets more quickly and
conveniently, even on modest hardware.</p>
<h3 id="efficiently-query-taxi-data-with-duckdb">Efficiently query taxi data with duckdb</h3>
<p>If you need even more speed and convenience you can use the <code>duckdb</code>
package. It allows you to query the same parquet datasets partitioned on
disk as we did above. You can use either SQL statements via the <code>DBI</code>
package or tidyverse style verbs using <code>dbplyr</code>. Let’s see how it works.</p>
<p>First we create a <code>duckdb</code> table from our <code>arrow</code> dataset.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="nf">library</span><span class="p">(</span><span class="n">duckdb</span><span class="p">)</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="nf">library</span><span class="p">(</span><span class="n">dplyr</span><span class="p">)</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="n">con</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">DBI</span><span class="o">::</span><span class="nf">dbConnect</span><span class="p">(</span><span class="n">duckdb</span><span class="o">::</span><span class="nf">duckdb</span><span class="p">())</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="n">fhvhv_tbl</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">to_duckdb</span><span class="p">(</span><span class="n">fhvhv_ds</span><span class="p">,</span><span class="w"> </span><span class="n">con</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;fhvhv&quot;</span><span class="p">)</span>
</code></pre></div>
<p>The <code>duckdb</code> table can be queried using tidyverse style verbs or SQL.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="c1">## number of Lyft trips, tidyverse style</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="n">fhvhv_tbl</span><span class="w"> </span><span class="o">%&gt;%</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="w">  </span><span class="nf">filter</span><span class="p">(</span><span class="n">hvfhs_license_num</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;HV0005&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="w">  </span><span class="nf">select</span><span class="p">(</span><span class="n">hvfhs_license_num</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="w">  </span><span class="nf">count</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>## # Source:   lazy query [?? x 1]
## # Database: duckdb_connection
##          n
##      &lt;dbl&gt;
## 1 37250101
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="c1">## number of Lyft trips, SQL style</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="n">y</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">dbSendQuery</span><span class="p">(</span><span class="n">con</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;SELECT COUNT(*) FROM fhvhv WHERE hvfhs_license_num==&#39;HV0005&#39;;&quot;</span><span class="p">)</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="nf">dbFetch</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>##   count_star()
## 1     37250101
</code></pre></div>
<p>The main advantages of <code>duckdb</code> are that it has full SQL support,
supports aggregating data in a streaming fashion, allows you to set
memory limits, and is optimized for speed. The way I think about the
relationship between <code>arrow</code> and <code>duckdb</code> is that <code>arrow</code> is primarily
about reading and writing data as fast and efficiently as possible, with
some built-in analysis capabilities, while <code>duckdb</code> is a database engine
with more complete data manipulation and aggregation capabilities.</p>
<p>It can be instructive to compare <code>arrow</code> and <code>duckdb</code> capabilities and
performance using a slightly more complicated example. Here we compute a
grouped average using <code>arrow</code>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="nf">system.time</span><span class="p">({</span><span class="n">fhvhv_ds</span><span class="w"> </span><span class="o">%&gt;%</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="w">    </span><span class="nf">filter</span><span class="p">(</span><span class="n">hvfhs_license_num</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;HV0005&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="w">    </span><span class="nf">select</span><span class="p">(</span><span class="n">hvfhs_license_num</span><span class="p">,</span><span class="w"> </span><span class="n">month</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="w">    </span><span class="nf">group_by</span><span class="p">(</span><span class="n">hvfhs_license_num</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="w">    </span><span class="nf">collect</span><span class="p">()</span><span class="w"> </span><span class="o">%&gt;%</span>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="w">    </span><span class="nf">summarize</span><span class="p">(</span><span class="n">avg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">mean</span><span class="p">(</span><span class="n">month</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="w">    </span><span class="nf">print</span><span class="p">()})</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>## # A tibble: 1 × 2
##   hvfhs_license_num   avg
##   &lt;chr&gt;             &lt;dbl&gt;
## 1 HV0005             6.10

##    user  system elapsed 
##  19.456   4.064  14.254
</code></pre></div>
<p>note that we use <code>collect</code> to read the data into memory before the
<code>summarize</code> step because <code>arrow</code> does not support aggregating in a
streaming fashion.</p>
<p>Here is the same query using <code>duckdb</code>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="nf">system.time</span><span class="p">({</span><span class="n">fhvhv_tbl</span><span class="w"> </span><span class="o">%&gt;%</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="w">    </span><span class="nf">filter</span><span class="p">(</span><span class="n">hvfhs_license_num</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;HV0005&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="w">    </span><span class="nf">select</span><span class="p">(</span><span class="n">hvfhs_license_num</span><span class="p">,</span><span class="w"> </span><span class="n">month</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="w">    </span><span class="nf">group_by</span><span class="p">(</span><span class="n">hvfhs_license_num</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="w">    </span><span class="nf">summarize</span><span class="p">(</span><span class="n">avg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">mean</span><span class="p">(</span><span class="n">month</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="w">    </span><span class="nf">print</span><span class="p">()})</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>## # Source:   lazy query [?? x 2]
## # Database: duckdb_connection
##   hvfhs_license_num   avg
##   &lt;chr&gt;             &lt;dbl&gt;
## 1 HV0005             6.10

##    user  system elapsed 
##  18.766   1.251   8.984
</code></pre></div>
<p>note that it is slightly faster, and we don’t need to read as much data
into memory because <code>duckdb</code> supports aggregating in a streaming
fashion. This capability is very powerful because it allows us to
perform computations on data that is too big to fit into memory.</p>
<h2 id="your-turn">Your turn!</h2>
<p>Now that you understand some of the basic techniques for working with
large data and have seen an example, you can start to apply what you’ve
learned. Using the same taxi data, try answering the following
questions:</p>
<ul>
<li>What percentage of trips are made by Lyft?</li>
<li>In which month did Lyft log the most trips?</li>
</ul>
<p>Documentation for these data can be found at
<a href="https://www1.nyc.gov/assets/tlc/downloads/pdf/data_dictionary_trip_records_hvfhs.pdf">https://www1.nyc.gov/assets/tlc/downloads/pdf/data_dictionary_trip_records_hvfhs.pdf</a></p>
<h2 id="additional-resources">Additional resources</h2>
<ul>
<li><a href="https://arrow.apache.org/docs/r/">Arrow R package documentation</a></li>
<li><a href="https://arrow.apache.org/docs/python/">Arrow Python package
    documentation</a></li>
<li><a href="https://duckdb.org/docs/">DuckDB documentation</a></li>
</ul>







  
  



  




                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; President & Fellows of Harvard College.
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
      <div class="md-consent" data-md-component="consent" id="__consent" hidden>
        <div class="md-consent__overlay"></div>
        <aside class="md-consent__inner">
          <form class="md-consent__form md-grid md-typeset" name="consent">
            


  


<h4>Cookie consent</h4>
<p>We use cookies to recognize your repeated visits and preferences, as well as to measure the effectiveness of our documentation and whether users find what they're searching for. With your consent, you're helping us to make our documentation better.
    </p>
<input class="md-toggle" type="checkbox" id="__settings" >
<div class="md-consent__settings">
  <ul class="task-list">
    
    
      
        
  
  
    
    
  
  <li class="task-list-item">
    <label class="task-list-control">
      <input type="checkbox" name="analytics" checked>
      <span class="task-list-indicator"></span>
      Google Analytics
    </label>
  </li>

      
    
    
      
        
  
  
    
    
  
  <li class="task-list-item">
    <label class="task-list-control">
      <input type="checkbox" name="github" checked>
      <span class="task-list-indicator"></span>
      GitHub
    </label>
  </li>

      
    
    
  </ul>
</div>
<div class="md-consent__controls">
  
    
      <button class="md-button md-button--primary">Accept</button>
    
    
    
  
    
    
    
      <label class="md-button" for="__settings">Manage settings</label>
    
  
</div>
          </form>
        </aside>
      </div>
      <script>var consent=__md_get("__consent");if(consent)for(var input of document.forms.consent.elements)input.name&&(input.checked=consent[input.name]||!1);else"file:"!==location.protocol&&setTimeout((function(){document.querySelector("[data-md-component=consent]").hidden=!1}),250);var form=document.forms.consent;for(var action of["submit","reset"])form.addEventListener(action,(function(e){if(e.preventDefault(),"reset"===e.type)for(var n of document.forms.consent.elements)n.name&&(n.checked=!1);__md_set("__consent",Object.fromEntries(Array.from(new FormData(form).keys()).map((function(e){return[e,!0]})))),location.hash="",location.reload()}))</script>
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["toc.integrate", "navigation.instant", "navigation.tabs", "navigation.tabs.sticky", "navigation.top", "content.action.edit"], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
    
  </body>
</html>